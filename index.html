<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard Mi Claro SSO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
        .header { background-color: #ff0000; color: white; padding: 20px; text-align: center; margin-bottom: 20px; }
        .section { background-color: white; padding: 15px; margin-bottom: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); border-top: 5px solid #ff0000; }
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 10px; }
        .control { margin-bottom: 20px; text-align: center; }
        .control label { font-weight: bold; margin-right: 10px; font-size: 16px; }
        .control input { padding: 8px; font-size: 16px; border: 1px solid #ff0000; }
        .kpi { display: flex; justify-content: space-around; margin: 10px 0; }
        .kpi-item { text-align: center; padding: 10px; background: #f9f9f9; border-radius: 5px; width: 20%; }
        .alerta-verde { color: green; font-weight: bold; }
        .alerta-rojo { color: red; font-weight: bold; }
        .alerta-amarillo { color: orange; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Dashboard Dinámico Mi Claro SSO</h1>
        <p>Análisis de Impacto en Volumen Automático y Tickets Creados</p>
    </div>

    <div class="control">
        <label for="dayInput">Día Seleccionado (Celda de Control):</label>
        <input type="number" id="dayInput" min="1" max="31" value="15" placeholder="Ej: 15">
    </div>

    <div id="kpis" class="kpi section">
        <div class="kpi-item">
            <h3>Volumen Día</h3>
            <p id="volumenDia">-</p>
        </div>
        <div class="kpi-item">
            <h3>Tickets Día</h3>
            <p id="ticketsDia">-</p>
        </div>
        <div class="kpi-item">
            <h3>Alerta Volumen</h3>
            <p id="alertaVolumen">-</p>
        </div>
        <div class="kpi-item">
            <h3>Alerta Tickets</h3>
            <p id="alertaTickets">-</p>
        </div>
    </div>

    <div class="section">
        <h2>Volumen Manejo en Automático</h2>
        <div class="chart-container">
            <canvas id="volumenChart"></canvas>
        </div>
    </div>

    <div class="section">
        <h2>Certificados de Tickets por Producto</h2>
        <div class="chart-container">
            <canvas id="certificadosChart"></canvas>
        </div>
    </div>

    <div class="section">
        <h2>Histórico Tickets por Producto</h2>
        <div class="chart-container">
            <canvas id="ticketsChart"></canvas>
        </div>
    </div>

    <div class="section">
        <h2>Índice Tips de Referimiento</h2>
        <div class="chart-container">
            <canvas id="indiceChart"></canvas>
        </div>
    </div>

    <script>
        // === REEMPLAZA AQUÍ con el ID correcto de tu Sheet (el que aparece en /d/ID/ en la URL)
        const SHEET_ID = '11ocB0TR717u1VcQSJKbt0TLbDcA6oVt35lVk21S2b8k';
        const SHEET_NAME = 'Datos_Brutos';

        async function cargarDatosGoogleSheets() {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}&headers=1`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Error de acceso: Verifica compartición pública');
                const text = await response.text();

                // Google envuelve el JSON con: "/*O_o*/\ngoogle.visualization.Query.setResponse(...);"
                // por eso hacemos substring desde 47 y quitamos los últimos 2 caracteres.
                const json = JSON.parse(text.substring(47).slice(0, -2));

                // Mapeo seguro y tolerante a celdas vacías
                const rows = json.table.rows.map(row => {
                    // row.c es el array de celdas; usar índices según tu estructura
                    return {
                        fecha: row.c[0]?.v || '',
                        dia: parseInt(row.c[1]?.v) || 0,
                        volumenAutomatico: parseFloat(row.c[2]?.v) || 0,
                        ticketsCreados: parseFloat(row.c[3]?.v) || 0
                    };
                }).filter(r => r.dia > 0); // conserva sólo filas válidas

                return rows;
            } catch (error) {
                console.error('Error al cargar datos:', error);
                alert('Error cargando datos. Verifica la compartición pública y el ID de la hoja.');
                return [];
            }
        }

        function actualizarKPIs(datos, diaSeleccionado) {
            const datoActual = datos.find(d => d.dia === diaSeleccionado);
            const datoAnterior = datos.find(d => d.dia === diaSeleccionado - 1);

            if (!datoActual) {
                document.getElementById('volumenDia').textContent = '-';
                document.getElementById('ticketsDia').textContent = '-';
                document.getElementById('alertaVolumen').textContent = '-';
                document.getElementById('alertaTickets').textContent = '-';
                return null;
            }

            document.getElementById('volumenDia').textContent = datoActual.volumenAutomatico;
            document.getElementById('ticketsDia').textContent = datoActual.ticketsCreados;

            const alertaVol = document.getElementById('alertaVolumen');
            const cambioVol = datoAnterior ? (datoActual.volumenAutomatico - datoAnterior.volumenAutomatico > 0 ? 'Sube' : 'Baja') : 'Igual';
            alertaVol.textContent = cambioVol;
            alertaVol.className = cambioVol === 'Sube' ? 'alerta-verde' : (cambioVol === 'Baja' ? 'alerta-rojo' : 'alerta-amarillo');

            const alertaTick = document.getElementById('alertaTickets');
            const cambioTick = datoAnterior ? (datoActual.ticketsCreados < datoAnterior.ticketsCreados ? 'Mejora' : 'Retroceso') : 'Igual';
            alertaTick.textContent = cambioTick;
            alertaTick.className = cambioTick === 'Mejora' ? 'alerta-verde' : (cambioTick === 'Retroceso' ? 'alerta-rojo' : 'alerta-amarillo');

            return datoActual; // devolvemos para usar en gráficos simulados
        }

        async function actualizarDashboard() {
            const datos = await cargarDatosGoogleSheets();
            if (datos.length === 0) return;
            const diaSeleccionado = parseInt(document.getElementById('dayInput').value) || 1;
            const datosFiltrados = datos.filter(d => d.dia <= diaSeleccionado).sort((a, b) => a.dia - b.dia);

            const datoActual = actualizarKPIs(datos, diaSeleccionado);
            // Si no hay datoActual, evitamos graficar cálculos con undefined.
            // Gráfico Volumen (Línea)
            const ctxVol = document.getElementById('volumenChart').getContext('2d');
            new Chart(ctxVol, {
                type: 'line',
                data: {
                    labels: datosFiltrados.map(d => `Día ${d.dia}`),
                    datasets: [{ label: 'Volumen', data: datosFiltrados.map(d => d.volumenAutomatico), borderColor: '#00CED1', fill: false }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });

            // Gráfico Certificados (Barras, simulados a partir de datoActual)
            const ctxCert = document.getElementById('certificadosChart').getContext('2d');
            const certData = datoActual ? [
                Math.round(datoActual.ticketsCreados * 0.4),
                Math.round(datoActual.ticketsCreados * 0.3),
                Math.round(datoActual.ticketsCreados * 0.3)
            ] : [0,0,0];
            new Chart(ctxCert, {
                type: 'bar',
                data: { labels: ['CANTV', 'MOD', 'DSL'], datasets: [{ label: 'Certificados', data: certData, backgroundColor: '#00FF00' }] },
                options: { scales: { y: { beginAtZero: true } } }
            });

            // Gráfico Tickets (Línea)
            const ctxTick = document.getElementById('ticketsChart').getContext('2d');
            new Chart(ctxTick, {
                type: 'line',
                data: {
                    labels: datosFiltrados.map(d => `Día ${d.dia}`),
                    datasets: [{ label: 'Tickets', data: datosFiltrados.map(d => d.ticketsCreados), borderColor: '#00CED1', fill: false }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });

            // Gráfico Índice (Línea, simulado como % de volumen)
            const ctxInd = document.getElementById('indiceChart').getContext('2d');
            new Chart(ctxInd, {
                type: 'line',
                data: {
                    labels: datosFiltrados.map(d => `Día ${d.dia}`),
                    datasets: [{ label: 'Índice', data: datosFiltrados.map(d => (d.volumenAutomatico / 1000 * 100).toFixed(1)), borderColor: '#00CED1', fill: false }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        document.getElementById('dayInput').addEventListener('input', actualizarDashboard);
        // carga inicial
        actualizarDashboard();
    </script>
</body>
</html>
